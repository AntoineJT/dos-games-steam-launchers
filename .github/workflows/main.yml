name: Build

on: [push, pull_request]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4.1.6

      - name: Build
        run: ./build.ps1

      - name: Generate build infos
        run: |
          "URL: ${{ github.server_url }}/${{ github.repository }}" | Out-File INFOS.txt
          "Commit URL: ${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}" | Out-File -Append INFOS.txt
          "Triggered by: ${{ github.actor }}" | Out-File -Append INFOS.txt
          "Date: $(Get-Date) (US-format, UTC)" | Out-File -Append INFOS.txt
          "Commit SHA: ${{ github.sha }}" | Out-File -Append INFOS.txt
          "Branch/Tag: ${{ github.ref_name }}" | Out-File -Append INFOS.txt

      # BRANCH TRIGGERED ONLY
      # Nightly binaries on push/pull requests
      - name: Upload binaries as zip artifact
        uses: actions/upload-artifact@v4.3.3
        if: ${{ github.ref_type == 'branch' }}
        with:
          name: Binaries @ ${{ github.sha }}
          path: |
            README.md
            dist/**.exe
            INFOS.txt
          if-no-files-found: error

      # TAG TRIGGERED ONLY
      - uses: actions/setup-node@v4.0.2
        if: ${{ github.ref_type == 'tag' }}
        with:
          node-version: 20.14.0

      - name: Render README to PDF
        if: ${{ github.ref_type == 'tag' }}
        run: |
          npm install markdown-pdf@11.0.0
          npx markdown-pdf --out README.pdf README.md

      - name: Zip it for release
        if: ${{ github.ref_type == 'tag' }}
        run: |
          Compress-Archive -Path "dist/**.exe", "INFOS.txt", "README.pdf" -DestinationPath "./old-games-steam-launcher_${{ github.sha }}.zip"

      # Release on version tag
      - name: Create release on tag
        uses: softprops/action-gh-release@v2.0.5
        if: ${{ github.ref_type == 'tag' }}
        with:
          name: ${{ github.ref_name }} @ Old Games Steam Launchers
          fail_on_unmatched_files: true
          generate_release_notes: true
          files: "old-games-steam-launcher_${{ github.sha }}.zip"
