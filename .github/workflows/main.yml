name: Build

on: [push, pull_request, tags]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4.1.6

      - name: Build
        run: |
          ./build.bat
          $Env:BUILD_DATE = Get-Date

      # BRANCH TRIGGERED ONLY
      # Nightly binaries on push/pull requests
      - name: Upload binaries as zip artifact
        uses: actions/upload-artifact@v4.3.3
        if: ${{ github.ref_type == 'branch' }}
        with:
          name: Binaries @ ${{ github.sha }}
          path: "*.exe"
          if-no-files-found: error

      # TAG TRIGGERED ONLY
      - name: Zip it for release
        run: |
          "URL: ${{ github.server_url }}/${{ github.repository }}" | Out-File INFOS.txt
          "Commit URL: ${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}" | Out-File -Append INFOS.txt
          "Build triggered by: ${{ github.actor }}" | Out-File -Append INFOS.txt
          "Date: $BUILD_DATE" | Out-File -Append INFOS.txt
          "Commit SHA: ${{ github.sha }}" | Out-File -Append INFOS.txt
          "Tag: ${{ github.ref_name }}" | Out-File -Append INFOS.txt
          Compress-Archive -Path "*.exe", "INFOS.txt", "README.md" -DestinationPath "old-games-steam-launcher_${{ github.ref_name }}.zip"

      # Release on version tag
      - name: Create release on tag
        uses: softprops/action-gh-release@v2.0.5
        if: ${{ github.ref_type == 'tag' }}
        with:
          name: ${{ github.ref_name }} @ Old Games Steam Launchers
          fail_on_unmatched_files: true
          generate_release_notes: true
          files: "old-games-steam-launcher_${{ github.ref_name }}.zip"
